Vercel Blob URLs — frontend usage

This file explains how the frontend (`mytarotreadings`) uses Vercel Blob URLs to display images.

Quick summary

- Uploaded images stored in Vercel Blob are public URLs like:
  `https://<project>.public.blob.vercel-storage.com/path/to/file.jpg`
- The frontend prefers to use blob URLs directly when available. Blob URLs are returned by the backend in API responses or mapped via `blob-url-mapping.json`.

Where the logic lives

- `lib/imageServiceWithBlob.js` — central image helper. It loads `blob-url-mapping.json` (if present) and prefers mapped blob URLs for cards and spreads.
- `lib/api.js` — utilities for detecting and extracting blob URLs from upload responses (`isBlobUrl`, `extractBlobUrl`, `prepareBlobUpload`).
- `components/SmartImageV2.jsx` (and `SmartImage.jsx`) — image components now detect full HTTP/blob URLs and use them directly (no double-transformation).
- `next.config.js` — includes `images.remotePatterns` to allow `**.vercel-storage.com` and `vercel-storage.com` for Next.js Image optimization.

Environment variables

- BLOB_READ_WRITE_TOKEN — required for scripts that upload to Vercel Blob (migration and seeding). Add to your `.env`:

  BLOB_READ_WRITE_TOKEN=vercel_blob_rw_xxxxx

- BLOB_MAPPING_ADMIN_TOKEN — (optional, recommended in production) when set on the server it is required to fetch the runtime mapping via `/api/blob-mapping`. Provide this token via `x-admin-token` header, `Authorization: Bearer <token>`, or `?token=` query param.

  Example (curl):

```bash
# using Authorization header
curl -H "Authorization: Bearer $BLOB_MAPPING_ADMIN_TOKEN" https://your-server.example.com/api/blob-mapping

# using custom header
curl -H "x-admin-token: $BLOB_MAPPING_ADMIN_TOKEN" https://your-server.example.com/api/blob-mapping
```

Migration and test scripts

- Migrate static frontend images to blob (generates `blob-url-mapping.json`):

```bash
# from the frontend project root
node scripts/migrate-images-to-blob.js
```

- Run the frontend blob mapping tests (loads `blob-url-mapping.json` and tests HTTP access):

```bash
node scripts/test-blob-images.js
```

- Browser quick test: open `blob-test-browser.js` in the browser console (imports `lib/imageService.js` and checks mapping).

How to render images in components

- If an API returns `image` fields that are full HTTPS blob URLs, use them directly in an `<img>` or in Next.js `<Image src={url} .../>` (Next.js image optimization is allowed by `next.config.js`).
- If you have a static path (e.g. `/images/rider-waite-tarot/cover.jpg`), use `lib/imageServiceWithBlob.js` helpers `getCardImageUrl()` / `getSpreadImageUrl()` or `transformImageUrl()` which consult `blob-url-mapping.json` first, then fall back to API endpoints.

Sample API response shapes (what frontend expects)

- Deck / Card objects returned from the server can include `image` fields that are already blob URLs:

```json
{
  "id": "...",
  "name": "Rider Waite",
  "image": "https://<project>.public.blob.vercel-storage.com/decks/rider-waite/cover.jpg"
}
```

Notes & troubleshooting

- If images 404, check `blob-url-mapping.json` (exists at the frontend root) and confirm the blob URLs are valid and publicly accessible in the Vercel dashboard Storage > Blob.
- Ensure `BLOB_READ_WRITE_TOKEN` is set when running upload/seed/migrate scripts.
- If you're using Next.js Image and still seeing blocked images, confirm `next.config.js` `remotePatterns` include your blob hostname exactly.
- Browser CORS: the server already sets `Access-Control-Allow-Headers` including `x-vercel-blob-store` on most APIs. When testing direct blob fetches, you may see no CORS responses for raw GETs — blob storage hosts should return normal CORS headers for public assets.

Relevant files

- `lib/imageServiceWithBlob.js`
- `lib/api.js`
- `scripts/migrate-images-to-blob.js`
- `scripts/test-blob-images.js`
- `blob-url-mapping.json` (generated by migration)
- `next.config.js`

If you'd like, I can:
- Add an endpoint that returns the `blob-url-mapping.json` from the server for remote verification, or
- Run the migration/test scripts locally (need the `BLOB_READ_WRITE_TOKEN` in environment), or
- Add a small UI page that lists mapped blob URLs for debugging.
